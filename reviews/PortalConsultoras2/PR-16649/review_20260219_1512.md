### ğŸ›¡ï¸ AuditorÃ­a de Seguridad & Calidad
> **Review por IA** | ğŸ¤– Antigravity | ğŸ“… 2026-02-19

---

### ğŸ“ Resumen
Este PR aÃ±ade logging detallado (tipo cURL) para depuraciÃ³n de transacciones Ztrans. Sin embargo, se ha detectado un **Riesgo de Seguridad CrÃ­tico (P0)**: el mÃ©todo `ProcessSale` estÃ¡ logueando el objeto `payment` completo sin activar el enmascaramiento explÃ­cito. Si este objeto contiene datos de tarjeta (PAN, CVV) o PII, se estarÃ­an exponiendo en los logs. El PR no puede ser aprobado hasta corregir esto.

---

### ğŸ“Š Tabla de Issues

| Tipo | Severidad | Archivo | DescripciÃ³n |
|:----:|:---------:|:--------|:------------|
| ğŸ›¡ï¸ | **P0** | `HttpZtransClient.cs` | **Potential Data Leak**: Logging de objeto `payment` sin enmascarar. |
| âš ï¸ | **P1** | `HttpZtransClient.cs` | **CÃ³digo Redundante**: Bloques `catch` duplicados en mÃºltiples mÃ©todos. |
| â„¹ï¸ | **P2** | `HttpZtransClient.cs` | **Performance**: SerializaciÃ³n triple para logs. |

---

### ğŸš« 1. Seguridad (Riesgos CrÃ­ticos)

#### âŒ **[P0] Logging de Datos Sensibles (Potential)**
> `Portal.Consultoras.Common/PagoEnLinea/Ztrans/HttpZtransClient.cs` (LÃ­neas 62, 75, 81)

Se estÃ¡ llamando a `BuildCurlLog(url, payment)` dentro de `ProcessSale`. A diferencia de `AuthenticateAsync`, en estas llamadas **NO** se pasa el parÃ¡metro `maskCard: true`, por lo que se usa el valor por defecto (`false`).

```csharp
// âŒ MAL: Se loguea el objeto payment completo
var curlLog = BuildCurlLog(url, payment); // maskCard es false
```

**Riesgo**: Si la clase `PaymentRequest` contiene nÃºmero de tarjeta, CVV, fecha de expiraciÃ³n o datos personales del cliente, estos quedarÃ¡n expuestos en texto plano en los logs del servidor y herramientas de monitoreo.
**SoluciÃ³n**:
1. Verificar contenido de `PaymentRequest`.
2. Si contiene datos sensibles, pasar `maskCard: true` (y actualizar `BuildCurlLog` para soportar `PaymentRequest`) o implementar un DTO seguro para logs.
3. Asegurarse de NUNCA loguear PAN/CVV.

---

### âš ï¸ 3. Importantes (Mantenibilidad / EstÃ¡ndares)

#### âš ï¸ **[P1] Manejo de Excepciones Redundante**
> `Portal.Consultoras.Common/PagoEnLinea/Ztrans/HttpZtransClient.cs`

En los mÃ©todos `CreateIdempotencyKey`, `ProcessSale` y `AuthenticateAsync`, se repite este patrÃ³n:

```csharp
catch (HttpRequestException ex)
{
    // LÃ³gica de log...
}
catch (Exception ex)
{
    // EXACTAMENTE la misma lÃ³gica de log...
}
```

La clase `HttpRequestException` hereda de `Exception`, por lo que el segundo bloque `catch (Exception ex)` ya es capaz de capturar ambas, y la lÃ³gica interna es idÃ©ntica (mismo mensaje, mismo log).
**SoluciÃ³n**: Eliminar la duplicidad. Unificar en un solo `catch (Exception ex)` si el tratamiento es idÃ©ntico.

---

### â„¹ï¸ 4. Mejoras (Performance / IdiomÃ¡tico)

#### â„¹ï¸ **[P2] Overhead de SerializaciÃ³n en Logs**
> `Portal.Consultoras.Common/PagoEnLinea/Ztrans/HttpZtransClient.cs`

El mÃ©todo `BuildCurlLog` realiza una "Triple SerializaciÃ³n" para enmascarar datos:
1. `SerializeObject(body)` (Input -> JSON)
2. `DeserializeObject(json)` (JSON -> Objeto Masked)
3. `SerializeObject(masked)` (Objeto Masked -> JSON final)

Esto aÃ±ade overhead innecesario al GC y CPU, especialmente en flujos crÃ­ticos como pagos.
**Sugerencia**: Para enmascarar, considerar usar un `ContractResolver` personalizado en una sola pasada de serializaciÃ³n, o clonar manualmente solo los campos necesarios si la estructura es simple.

---

### ğŸ’¯ PuntuaciÃ³n: **0/100**

> **Desglose:**
> - Base: 100
> - **ViolaciÃ³n P0 (Seguridad)**: -100

---

### ğŸ Veredicto: **âš ï¸ REQUEST CHANGES**
**RazÃ³n**: El riesgo de seguridad (P0) por posible exposiciÃ³n de datos de tarjeta en logs impide la aprobaciÃ³n. Se requiere correcciÃ³n inmediata o confirmaciÃ³n de que `PaymentRequest` es seguro.

---

#### ğŸ“š Referencias
*   [C# Coding Conventions](https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/coding-style/coding-conventions)
*   [OWASP Logging Guide](https://cheatsheetseries.owasp.org/cheatsheets/Logging_Vocabulary_Cheat_Sheet.html)
