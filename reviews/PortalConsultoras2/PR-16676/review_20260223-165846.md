# ü§ñ Code Review - PR #16676

üìä **Puntaje General**: 65/100 ‚≠ê‚≠ê‚≠ê
Veredicto: **‚ùå REQUEST CHANGES**

## üìà Desglose de Puntaje
| Categor√≠a | Puntaje | Peso | Contribuci√≥n |
|-----------|---------|------|--------------|
| Funcionalidad | 3/5 | 20% | 12.0 |
| Robustez | 2/5 | 20% | 8.0 |
| Mantenibilidad | 4/5 | 20% | 16.0 |
| Testabilidad | 3/5 | 15% | 9.0 |
| Escalabilidad | 4/5 | 10% | 8.0 |
| Arquitectura | 4/5 | 15% | 12.0 |
| **TOTAL** | | | **65/100** |

> **Classification**: M / Alto Risk
> **Reviewer**: AI Auditor (FPININ)
> **Stack Detectado**: C# (.cs)
> **Desarrollador**: Johanatan Castillo - Tismart
> **Fecha**: 2026-02-23
> **¬øListo para fusionar?**: NO

---

## üî¥ Problemas Cr√≠ticos (P0 - Blocking)
> *Issues de seguridad, crashes, o violaciones de reglas estrictas. Deben corregirse obligatoriamente.*

1. **[Crash Risk] NullReferenceException en BuildCurlLog**
   - **Archivo**: `packages/app/Portal.Consultoras.Common/PagoEnLinea/Ztrans/HttpZtransClient.cs`
   - **Problema**: El m√©todo `BuildCurlLog` llama a `JObject.FromObject(body, ...)` sin validar si `body` es nulo. Si por alg√∫n motivo el objeto `payment` o `body` llega nulo a los m√©todos `ProcessSale`, `AuthenticateAsync` o `GetStatus3DsAsync`, la aplicaci√≥n lanzar√° una excepci√≥n fatal al intentar generar el log.
   - **Riesgo**: Crash en producci√≥n durante el flujo de pago.
   - **Tiempo est.**: 2 minutos
   - **Soluci√≥n sugerida**:
     ```csharp
     if (body == null) return "curl [no body]";
     ```

---

## üü° Problemas Importantes (P1 - High Priority)
> *Problemas de performance, bugs probables o deuda t√©cnica alta.*

1. **[L√≥gica] Inconsistencia en Key de Enmascarado (`acctNumber`)**
   - **Archivo**: `packages/app/Portal.Consultoras.Common/PagoEnLinea/Ztrans/HttpZtransClient.cs`
   - **Problema**: Se cambi√≥ la clave de b√∫squeda de `AcctNumber` a `acctNumber` y se especific√≥ un `DefaultContractResolver`. En C#, si las propiedades del modelo son PascalCase y no tienen atributos `JsonProperty`, `JObject.FromObject` generar√° claves PascalCase. Esto har√° que `jObject["acctNumber"]` sea null y el enmascarado preventivo no se ejecute.
   - **Impacto**: Aunque los datos est√©n encriptados, el sistema falla en su intenci√≥n de aplicar "Defense in Depth" (enmascarar el ciphertext para logs).
   - **Soluci√≥n sugerida**: Usar `CamelCasePropertyNamesContractResolver` o asegurar que la clave coincida con el nombre real de la propiedad en el modelo.

2. **[Robustez] Eliminaci√≥n de Guards de Enmascarado (`cvv`, `card-number`)**
   - **Problema**: Se eliminaron las validaciones para `cvv` y `card-number` en el m√©todo `BuildCurlLog`.
   - **Riesgo**: Aunque los datos est√©n encriptados, mantener estas capas de seguridad evita que ante cualquier cambio futuro en el flujo (donde se reciba el dato plano por error o en test) el dato sensible sea logueado. Es una buena pr√°ctica de seguridad bancaria mantener estos guards siempre.
   - **Soluci√≥n sugerida**: Reincorporar el enmascarado de `cvv` por precauci√≥n.

---

## üü¢ Recomendaciones (P2/P3)
- üí° [P2] Usar una lista blanca de campos permitidos en logs de RED en lugar de una lista negra para mayor seguridad.
- ‚ÑπÔ∏è [P3] El refactor de `LogManager.SaveLogInfo` es positivo para la observabilidad del sistema. 

---

## ‚úÖ Aspectos Positivos
- ‚úÖ Uso de Feature Flag para controlar los logs de √©xito.
- ‚úÖ Mejora en la estructuraci√≥n de la data de error.

---

## üìù Sugerencia de Commit
 `[TICKET-16676] -FIX Fix sensitive data masking in HttpZtransClient`

